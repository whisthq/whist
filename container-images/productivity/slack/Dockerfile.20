FROM fractal/browsers/chrome:current-build

# Install Slack dependencies explicitly
RUN apt-get update && apt-get install --allow-downgrades -y \
    libappindicator1 \
    dbus-x11 \
    gconf-service-backend \
    gconf-service \
    libc6 \
    libgconf-2-4 \
    libglib2.0-0 \
    libxml2 \
    psmisc \
    python \
    gconf2 \
    python3 \
    gvfs-common \
    gvfs \
    gvfs-bin \
    jq \
    && apt-get autoremove -y \
    && apt-get clean

# Install Slack
RUN wget --quiet https://downloads.slack-edge.com/linux_releases/slack-desktop-4.0.2-amd64.deb -O /tmp/slack-desktop-4.0.2-amd64.deb && \
    cd /tmp/ && \
    dpkg -i slack-desktop-4.0.2-amd64.deb && \
    rm -rf /tmp/slack-desktop*.deb

# Install wrapper script into /usr/bin
RUN rm /usr/bin/slack
COPY run-slack.sh /usr/bin/slack
RUN chmod +x /usr/bin/slack

# Whitelist slack:// in google-chrome
RUN mkdir -p /etc/opt/chrome/policies/managed \
    && echo {} \
    | jq '.URLWhitelist=["slack://*"]' \
    > /etc/opt/chrome/policies/managed/whitelist.json

# Setup Fractal application symlink
RUN ln -sf /usr/bin/slack /usr/bin/fractal-application
